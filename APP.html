<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>醫師用藥決策 APP - SMART on FHIR</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f6f9; padding: 20px; }
        .card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1, h2 { color: #0056b3; }
        .highlight { background-color: #ffcccc; color: #d9534f; font-weight: bold; padding: 5px; border-radius: 4px; }
        #loading { font-style: italic; color: #666; }
    </style>
</head>
<body>
    <h1>糖尿病用藥決策支援系統</h1>
    <div id="loading">讀取病患資料中...</div>

    <div id="content" style="display:none;">
        <div class="card">
            <h2>病患資訊</h2>
            <p id="patient-info"></p>
        </div>

        <div class="card">
            <h2>臨床檢驗與診斷</h2>
            <div id="clinical-info"></div>
        </div>

        <div class="card">
            <h2>ADA 2025 藥物建議</h2>
            <ul id="recommendations"></ul>
        </div>
    </div>

    <script>
        FHIR.oauth2.ready().then(client => {
            console.log("SMART Client 已就緒", client);

            // 1. 抓取病患基本資料
            const getPatient = client.patient.read();

            // 2. 抓取最近一次 HbA1c (LOINC: 4548-4)
            const getA1c = client.request(`Observation?patient=${client.patient.id}&code=4548-4&_sort=-date&_count=1`);

            // 3. 抓取診斷資料 (Condition)，確認有無 CVD 或 CKD
            const getConditions = client.request(`Condition?patient=${client.patient.id}`);

            Promise.all([getPatient, getA1c, getConditions]).then(([patient, a1cBundle, conditionBundle]) => {
                document.getElementById("loading").style.display = "none";
                document.getElementById("content").style.display = "block";

                // 處理姓名
                const name = patient.name ? patient.name[0].text : "未知";
                document.getElementById("patient-info").innerHTML = `<strong>姓名：</strong>${name} (ID: ${patient.id})`;

                // 處理 HbA1c
                let a1cValue = 0;
                if (a1cBundle.entry && a1cBundle.entry.length > 0) {
                    a1cValue = a1cBundle.entry[0].resource.valueQuantity.value;
                }
                
                // 處理併發症
                let complications = [];
                if (conditionBundle.entry) {
                    conditionBundle.entry.forEach(e => {
                        const code = e.resource.code.text || "";
                        if (code.includes("CVD") || code.includes("Heart")) complications.push("CVD");
                        if (code.includes("CKD") || code.includes("Kidney")) complications.push("CKD");
                    });
                }

                document.getElementById("clinical-info").innerHTML = `
                    糖化血色素 (HbA1c): <strong>${a1cValue}%</strong><br>
                    已知併發症: ${complications.length > 0 ? complications.join(", ") : "無"}
                `;

                // --- 藥物決策邏輯 (根據你原始的 ADA 2025 指引) ---
                let recs = [];
                // 根據 HbA1c 判斷
                if (a1cValue > 9) {
                    recs.push(`<li class="highlight">A1C > 9%：建議起始 Metformin + GLP-1 RA</li>`);
                } else if (a1cValue > 7.5) {
                    recs.push(`<li>A1C > 7.5%：建議 Metformin + GLP-1 RA 或 SGLT2i</li>`);
                } else {
                    recs.push(`<li>A1C ≤ 7.5%：建議 Metformin 單一治療</li>`);
                }

                // 根據併發症判斷
                if (complications.includes("CVD")) {
                    recs.push(`<li class="highlight">偵測到 CVD：優先建議使用 GLP-1 RA 或 SGLT2i</li>`);
                }
                if (complications.includes("CKD")) {
                    recs.push(`<li class="highlight">偵測到 CKD：優先建議使用 SGLT2i</li>`);
                }

                document.getElementById("recommendations").innerHTML = recs.join("");
            });
        }).catch(err => {
            document.getElementById("loading").innerHTML = "錯誤: 無法與 FHIR Server 連線 (" + err + ")";
        });
    </script>
</body>
</html>